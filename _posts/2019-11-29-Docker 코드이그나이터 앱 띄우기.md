---  
layout: post
title: Docker 코드이그나이터 앱 띄우기
gh-repo: daattali/beautiful-jekyll
tags: [docker, apache, vm]
comments: true
---

# Dockerfile
제가 유지보수하는 앱은 카페24 CentOS 서버에 Apache, PHP 를 사용하는 전통적인 환경에서 돌아가고 있습니다. 
개발을 진행하는 로컬 맥에 개발 환경 세팅을 도커를 활용하여 하고자하였습니다. 

## Document Root 변경
현재 운영 중인 서비스가 코드이그나이터를 이용하여 다음과 같은 구조를 가지고 있습니다.  
m.domain.kr -> app/m -> app/CI/application/m/  
www.domain.kr -> app/www -> app/CI/application/www/  
DocumentRoot는 app/m 을 향하면서 -v 옵션으로 링크하는 영역은 하나 뒤 영역인 app/을 잡아야합니다.  
Docker hub에 공유되어있는 대부분의 컨테이너는 링크 폴더를 곳 DocumentRoot로 사용하기 때문에 바로 적용할 수 없어 Dockfile에 다음과 같이 수정합니다. 

~~~
  ENV APACHE_DOCUMENT_ROOT=/var/www/html/m
  RUN sed -ri -e 's!/var/www/html!${APACHE_DOCUMENT_ROOT}!g' /etc/apache2/sites-available/*.conf
  RUN sed -ri -e 's!/var/www/!${APACHE_DOCUMENT_ROOT}!g' /etc/apache2/apache2.conf /etc/apache2/conf-available/*.conf
~~~

## 코드이그나이터 셋업
코드이그나이터에서 session.auto_start를 사용하기 때문에 php.ini에서 옵션을 추가합니다.
~~~
RUN { \
    echo 'log_errors=on'; \
    echo 'display_errors=off'; \
    echo 'upload_max_filesize=32M'; \
    echo 'post_max_size=32M'; \
    echo 'memory_limit=128M'; \
    echo 'date.timezone="UTC"'; \
    echo 'session.auto_start=1'; \
  } > /usr/local/etc/php/conf.d/docker-ci-php.ini
~~~

## 500 에러 발생
mysql - mysqli 
mysql과 php의 버전 문제 실섭에 맞춰 mysql 설치를 추가
mysql이 설치되어 있지 않아서 500에러를 노출

~~~
RUN apt-get update && apt-get install -y git-core cron \
  libjpeg-dev libmcrypt-dev libpng-dev libpq-dev \
  && rm -rf /var/lib/apt/lists/* \
  && docker-php-ext-configure gd --with-png-dir=/usr --with-jpeg-dir=/usr \
  && docker-php-ext-install gd mcrypt mysqli mysql opcache pdo pdo_mysql zip
~~~  

<center><img src ="https://trello-attachments.s3.amazonaws.com/5db8f4b864493b4c6f0c56bd/5de0c694ea6cfb7ee7170f75/ce4584f5b40b556675d0ef7ff928255d/image.png" width="80%;"></center>
<center><img src ="https://trello-attachments.s3.amazonaws.com/5db8f4b864493b4c6f0c56bd/5de0c694ea6cfb7ee7170f75/a6e78153dcc073488f76afb3311245eb/image.png" width="80%;"></center>

Dockerfile 수정하고 반영하는 플로우


## Dockerfile

~~~
# 베이스 이미지를 기반으로 컨테이너를 생성해나갑니다.
FROM php:5.6.30-apache

# RUN 은 터미널에 명령어를 입력하는 것과 동일하게 동작합니다. 컨테이너 환경에 필요한 요소들을 다운로드하고 설치합니다.
# 버전 문제인지 mysqli로는 현재 실서버 DB와 연동이 안돼(500에러) mysql 을 추가했습니다.
RUN apt-get update && apt-get install -y git-core cron \
  libjpeg-dev libmcrypt-dev libpng-dev libpq-dev \
  && rm -rf /var/lib/apt/lists/* \
  && docker-php-ext-configure gd --with-png-dir=/usr --with-jpeg-dir=/usr \
  && docker-php-ext-install gd mcrypt mysqli mysql opcache pdo pdo_mysql zip

# Recommended opcache settings - https://secure.php.net/manual/en/opcache.installation.php
RUN { \
    echo 'opcache.memory_consumption=128'; \
    echo 'opcache.interned_strings_buffer=8'; \
    echo 'opcache.max_accelerated_files=4000'; \
    echo 'opcache.revalidate_freq=2'; \
    echo 'opcache.fast_shutdown=1'; \
    echo 'opcache.enable_cli=1'; \
  } > /usr/local/etc/php/conf.d/docker-ci-opcache.ini

# 해당 경로에 내용을 추가합니다.
# sesion.auto_start 1 설정
RUN { \
    echo 'log_errors=on'; \
    echo 'display_errors=off'; \
    echo 'upload_max_filesize=32M'; \
    echo 'post_max_size=32M'; \
    echo 'memory_limit=128M'; \
    echo 'date.timezone="UTC"'; \
    echo 'session.auto_start=1'; \
  } > /usr/local/etc/php/conf.d/docker-ci-php.ini

RUN { \
    echo '<FilesMatch "^\.">'; \
    echo '    Order allow,deny'; \
    echo '    Deny from all'; \
    echo '</FilesMatch>'; \
    echo '<DirectoryMatch "^\.|\/\.">'; \
    echo '    Order allow,deny'; \
    echo '    Deny from all'; \
    echo '</DirectoryMatch>'; \
  } > /etc/apache2/conf-available/docker-ci-php.conf

  # 환경변수를 추가할 수 있습니다. apache 서버의 documentRoot를 환경변수로 지정할 수 있도록합니다. 
  # 이부분은 궁극적으로 Virutal Host가 잡히면 필요 없어집니다.
  ENV APACHE_DOCUMENT_ROOT=/var/www/html/m
  RUN sed -ri -e 's!/var/www/html!${APACHE_DOCUMENT_ROOT}!g' /etc/apache2/sites-available/*.conf
  RUN sed -ri -e 's!/var/www/!${APACHE_DOCUMENT_ROOT}!g' /etc/apache2/apache2.conf /etc/apache2/conf-available/*.conf

RUN a2enconf docker-ci-php

RUN a2enmod rewrite

COPY --chown=www-data:www-data ./CodeIgniter_1.7.3 /usr/src/CodeIgniter_1.7.3

RUN ln -s /usr/src/CodeIgniter_1.7.3/system /var/www/codeigniter

COPY docker-entrypoint /usr/local/bin/

ENTRYPOINT ["docker-entrypoint"]
CMD ["apache2-foreground"]
~~~

# 다중 컨테이너
모바일, 웹, 관리자 사이트를 각각 어떻게 띄울지를 고민했습니다. 원래 apache virtual host로 각각 띄우는데 컨테이너에서 어떻게 처리해야할지 고민하다가 다중 컨테이너를 사용하여 띄우는걸로 생각하였습니다. docker-compose.yml을 다음과 같이 수정하여 다중 컨테이러를 설정합니다. 

~~~
# docker-compose.yml
version: '2.2'
services:
  m:
    image: hojindev/codeigniter_hmvc
    ports:
     - 80:80
    volumes:
      - $PWD:/var/www/html/
    environment:
      - APACHE_DOCUMENT_ROOT="/var/www/html/m"

  web:
    image: hojindev/codeigniter_hmvc
    ports:
      - 81:80
    volumes:
      - $PWD:/var/www/html/
    environment:
      - APACHE_DOCUMENT_ROOT="/var/www/html/www"
        
  admin:
    image: hojindev/codeigniter_hmvc
    ports:
      - 82:80
    volumes:
      - $PWD:/var/www/html/
    environment:
      - APACHE_DOCUMENT_ROOT="/var/www/html/admin"
~~~


## 실행
~~~
docker-compose up
~~~

https://hub.docker.com/r/aspendigital/codeigniter 소스 포크하여 사용하였습니다.   

https://hub.docker.com/repository/docker/hojindev/codeigniter_hmvc  
  
